# Google ADK Multi-Agent System

Production-ready FastAPI server for Google ADK agents using uvicorn.

## Quick Start

### Prerequisites

1. **Install dependencies**:
   ```bash
   uv sync
   ```

2. **Setup Google Cloud Authentication**:
   ```bash
   # Login with Application Default Credentials
   gcloud auth application-default login

   # Set your project (optional - uses your default project if not set)
   gcloud config set project YOUR_PROJECT_ID
   ```

3. **Configure environment** (optional):
   ```bash
   # Copy example config
   cp .env.example .env

   # Edit .env to customize settings
   # All settings have sensible defaults and can be overridden
   ```

### Start the Server

```bash
# Start the server (development mode with auto-reload)
uv run python server.py

# Or use uvicorn directly
uv run uvicorn server:app --host 0.0.0.0 --port 8010 --reload
```

Access the server at: http://localhost:8010

## Endpoints

### Custom Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/` | GET | Web UI for interacting with agents |
| `/health` | GET | Health check endpoint (for monitoring) |
| `/info` | GET | Service information and available agents |
| `/docs` | GET | OpenAPI documentation (Swagger UI) |
| `/openapi.json` | GET | OpenAPI schema (JSON format) |
| `/redoc` | GET | ReDoc API documentation |

### API Endpoints for Frontend Integration

All ADK endpoints follow the pattern: `/apps/{app_name}/users/{user_id}/sessions/{session_id}/...`

**Base URL Pattern:**
- `app_name`: Agent name (e.g., `movie_pitch_agent`)
- `user_id`: User identifier (e.g., `user123`)
- `session_id`: Session UUID

#### Session Management

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/apps/{app_name}/users/{user_id}/sessions` | GET | List all sessions for a user |
| `/apps/{app_name}/users/{user_id}/sessions` | POST | Create a new session |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}` | GET | Get session details and messages |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}` | POST | Send a message to the agent |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}` | DELETE | Delete a session |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}` | PATCH | Update session metadata |

#### Artifact Management

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}/artifacts` | GET | List all artifacts in session |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}/artifacts/{artifact_name}` | GET | Download artifact (latest version) |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}/artifacts/{artifact_name}` | DELETE | Delete an artifact |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}/artifacts/{artifact_name}/versions` | GET | List all versions of an artifact |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}/artifacts/{artifact_name}/versions/{version_id}` | GET | Download specific artifact version |

#### Agent Execution

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/run` | POST | Execute agent (JSON response) |
| `/run_sse` | POST | Execute agent (Server-Sent Events stream) |

#### Debug & Tracing

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/debug/trace/session/{session_id}` | GET | Get execution trace for session |
| `/debug/trace/{event_id}` | GET | Get execution trace for specific event |
| `/apps/{app_name}/users/{user_id}/sessions/{session_id}/events/{event_id}/graph` | GET | Get execution graph for event |

### Frontend Integration Notes

**CORS Configuration:**
- By default, all origins are allowed (`ALLOWED_ORIGINS=*`)
- For production, set specific origins: `ALLOWED_ORIGINS=https://yourapp.com,https://app.yourapp.com`
- The server is configured for CORS to support frontend applications

**Authentication:**
- Currently no authentication required (add your own auth middleware if needed)
- Consider adding JWT or session-based auth for production

**Session Management:**
- Sessions persist in SQLite (development) or PostgreSQL (production)
- Each user can have multiple sessions
- Sessions store conversation history and state

**Artifacts:**
- Artifacts are files generated by the agent (e.g., movie pitch documents)
- Stored per session
- Support versioning (multiple versions of same artifact)
- Download via HTTP GET with proper Content-Type headers

### Example API Usage

#### 1. Create a Session

```bash
POST /apps/movie_pitch_agent/users/user123/sessions
Content-Type: application/json

{}
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "app_name": "movie_pitch_agent",
  "user_id": "user123",
  "created_at": "2025-10-31T10:00:00Z",
  "state": {}
}
```

#### 2. Send a Message to Agent

```bash
POST /apps/movie_pitch_agent/users/user123/sessions/{session_id}
Content-Type: application/json

{
  "message": {
    "role": "user",
    "parts": [{"text": "Create a movie pitch about Ada Lovelace"}]
  }
}
```

**Response (streaming via SSE):**
The agent will respond with events containing the conversation and any tool calls.

#### 3. List Artifacts

```bash
GET /apps/movie_pitch_agent/users/user123/sessions/{session_id}/artifacts
```

**Response:**
```json
{
  "artifacts": [
    {
      "filename": "The Lovelace Code.txt",
      "versions": [0],
      "latest_version": 0
    }
  ]
}
```

#### 4. Download Artifact

```bash
GET /apps/movie_pitch_agent/users/user123/sessions/{session_id}/artifacts/The%20Lovelace%20Code.txt
```

**Response:**
Raw file content with appropriate `Content-Type` header.

#### 5. List Sessions

```bash
GET /apps/movie_pitch_agent/users/user123/sessions
```

**Response:**
```json
{
  "sessions": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "app_name": "movie_pitch_agent",
      "user_id": "user123",
      "created_at": "2025-10-31T10:00:00Z"
    }
  ]
}
```

## Available Agents

- **movie_pitch_agent**: Movie pitch generation with iterative refinement
  - Demonstrates LoopAgent, ParallelAgent, and SequentialAgent patterns
  - Creates movie pitch documents with screenwriter, researcher, and critic agents
  - Saves artifacts to session storage

## Configuration

All configuration is in `config.py` with environment variable overrides.

### Environment Variables

Create a `.env` file (optional - defaults work for most cases):

```bash
# AI Model
MODEL=gemini-2.5-flash

# Server configuration
PORT=8010
HOST=0.0.0.0
ENVIRONMENT=development  # or production

# Session storage
SESSION_DB_URL=sqlite:///./sessions.db

# CORS
ALLOWED_ORIGINS=*

# Google Cloud (optional - uses gcloud defaults)
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_CLOUD_LOCATION=us-central1

# Cloud Logging (optional)
ENABLE_CLOUD_LOGGING=false
```

### Authentication

This project uses **Google Application Default Credentials (ADC)**:

```bash
# For local development
gcloud auth application-default login

# For production (uses service account automatically)
# Set GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json
# Or deploy to Cloud Run/GKE (credentials provided automatically)
```

## Production Deployment

### Local/VM Deployment

```bash
# Install dependencies
uv sync

# Run with multiple workers (production)
ENVIRONMENT=production uv run uvicorn server:app \
  --host 0.0.0.0 \
  --port 8010 \
  --workers 4
```

### Cloud Run Deployment

```bash
# Build and deploy to Cloud Run
gcloud run deploy adk-agents \
  --source . \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars ENVIRONMENT=production,MODEL=gemini-2.5-flash

# Or use the provided Dockerfile
docker build -t gcr.io/YOUR_PROJECT/adk-agents .
docker push gcr.io/YOUR_PROJECT/adk-agents
gcloud run deploy adk-agents --image gcr.io/YOUR_PROJECT/adk-agents
```

### Production Recommendations

1. **Session Storage**: Use PostgreSQL instead of SQLite for multi-instance deployments
   ```bash
   SESSION_DB_URL=postgresql://user:pass@host:5432/dbname
   ```

2. **Artifact Storage**: Use GCS for persistent artifact storage (currently uses in-memory)
   ```python
   # Configure in config.py
   USE_GCS_ARTIFACTS=true
   GCS_BUCKET=your-bucket-name
   ```

3. **Cloud Logging**: Enable for production monitoring
   ```bash
   ENABLE_CLOUD_LOGGING=true
   ```

## Setup for New Teams/Projects

### Different GCP Project

1. **Set your project**:
   ```bash
   gcloud config set project YOUR_NEW_PROJECT_ID
   gcloud auth application-default login
   ```

2. **Enable required APIs**:
   ```bash
   gcloud services enable aiplatform.googleapis.com
   ```

3. **Deploy** - no code changes needed!

### Different Region

Set the region via environment variable:
```bash
export GOOGLE_CLOUD_LOCATION=europe-west1
# Or add to .env file
```

### Different Environment (dev/staging/prod)

```bash
# Development
ENVIRONMENT=development uv run python server.py

# Staging
ENVIRONMENT=staging uv run uvicorn server:app --port 8010

# Production
ENVIRONMENT=production uv run uvicorn server:app --workers 4
```

## Architecture

This server uses the production-ready pattern:
- **Manual service initialization** - Full control over ADK services
- **Explicit service creation** - Session, artifact, memory, credential services
- **Google ADC authentication** - No API keys in code, uses gcloud credentials
- **SQLite session persistence** - Sessions survive server restarts (use PostgreSQL for production)
- **In-memory artifacts** - Fast for development (use GCS for production)
- **CORS support** - Configurable origins
- **Proper logging** - Structured logging with levels

See `server.py` for implementation details.

## Project Structure

```
.
├── config.py                 # Configuration with env var overrides
├── server.py                 # FastAPI server
├── callback_logging.py       # Logging utilities
├── movie_pitch_agent/        # Movie pitch agent
│   └── agent.py             # Agent definition
├── pyproject.toml           # Dependencies (managed by uv)
├── sessions.db              # SQLite session storage
└── README.md                # This file
```

## Development

```bash
# Start with auto-reload
uv run python server.py

# Or use uvicorn directly
uv run uvicorn server:app --reload --port 8010

# Run agent directly (without server)
uv run python movie_pitch_agent/agent.py

# Use ADK web interface
adk web
```

## Troubleshooting

### Authentication Errors

```bash
# Re-authenticate
gcloud auth application-default login

# Check current project
gcloud config get-value project

# Set project explicitly
gcloud config set project YOUR_PROJECT_ID
```

### Permission Errors

Enable required APIs:
```bash
gcloud services enable aiplatform.googleapis.com
```

Grant service account permissions (for Cloud Run):
```bash
gcloud projects add-iam-policy-binding PROJECT_ID \
  --member="serviceAccount:SERVICE_ACCOUNT@PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/aiplatform.user"
```

## Support

- See `CLAUDE.md` for detailed development documentation
- Report issues: [GitHub Issues](https://github.com/your-org/your-repo/issues)
