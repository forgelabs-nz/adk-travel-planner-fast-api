# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Python project `reflex-adk-test` (v0.1.0) using **uv** for package management. Requires Python 3.11+.

## Package Manager: uv

This project uses `uv` instead of pip/poetry. **Never manually edit `pyproject.toml` for dependencies** - always use `uv add` instead.

Key commands:

```bash
# Initialize new project
uv init

# Create virtual environment
uv venv

# Activate virtual environment
source .venv/bin/activate

# Check Python version
which python

# Run Python scripts
uv run python script.py

# Run commands in the uv environment
uv run <command>

# Add dependencies
uv add <package>

# Install dependencies from pyproject.toml
uv sync
```

## Python Version

Python version is pinned to `3.11` in `.python-version`.

## Project Architecture

This is a **Google ADK (Agent Development Kit) multiagent system** project demonstrating various agent patterns and workflows.

### Key Dependencies

- `google-adk`: Google's Agent Development Kit for building LLM-based agents
- `google-genai`: Google's Generative AI SDK
- `langchain-community`: Community integrations for LangChain (used for Wikipedia tool)
- `google-cloud-logging`: Cloud logging integration

### Agent Patterns

The project demonstrates three main multiagent patterns:

1. **SequentialAgent**: Agents execute in sequence, passing state between them
2. **LoopAgent**: Agents iterate until a condition is met (max iterations or exit_loop tool)
3. **ParallelAgent**: Agents execute concurrently

### Project Structure

- `config.py`: Central configuration with environment variable overrides
- `server.py`: FastAPI server for production deployment
- `callback_logging.py`: Logging utilities for tracking LLM requests/responses
- `movie_pitch_agent/`: Movie pitch generation agent with iterative refinement
  - Demonstrates LoopAgent (writers_room), ParallelAgent (preproduction_team), and SequentialAgent patterns
  - Uses screenwriter, researcher, and critic agents in a workflow
  - Saves movie pitches as session artifacts (viewable in Web UI)

### Key Concepts

- **State Management**: Agents share state via `tool_context.state`
- **Tool Context**: Tools receive `ToolContext` for accessing/modifying shared state
- **Callbacks**: `before_model_callback` and `after_model_callback` for logging
- **Sub-agents**: Agents can have hierarchical relationships via `sub_agents` parameter
- **Output Keys**: Agents can write to specific state keys via `output_key` parameter

### Configuration

All configuration is in `config.py` with sensible defaults:
- **MODEL**: `gemini-2.5-flash` (can override with `MODEL` env var)
- **PORT**: `8010` (can override with `PORT` env var)
- **HOST**: `0.0.0.0` (can override with `HOST` env var)
- **ENVIRONMENT**: `development` (can be `development` or `production`)
- **SESSION_DB_URL**: `sqlite:///./sessions.db` (use PostgreSQL for production)
- **GOOGLE_CLOUD_PROJECT**: Uses gcloud config by default (optional override)
- **GOOGLE_CLOUD_LOCATION**: `us-central1` (can override with env var)

To override, set environment variables or create a `.env` file.

### Google Cloud Authentication

Uses **Application Default Credentials (ADC)**:
```bash
gcloud auth application-default login
gcloud config set project YOUR_PROJECT_ID
```

The project and credentials are automatically detected from your gcloud config.

### Running Agents

#### Interactive Mode (CLI/Web)

```bash
# Run movie pitch agent directly
uv run python movie_pitch_agent/agent.py

# Web interface (ADK built-in)
adk web
```

#### FastAPI Server (Production)

The project includes a FastAPI server (`server.py`) that exposes agents as HTTP endpoints:

```bash
# Start server directly
uv run python server.py

# Or use uvicorn with auto-reload (development)
uv run uvicorn server:app --host 0.0.0.0 --port 8010 --reload

# Production deployment
uv run uvicorn server:app --host 0.0.0.0 --port 8010 --workers 4
```

**Server Endpoints:**
- `GET /`: Web UI for interacting with agents
- `GET /health`: Health check endpoint for monitoring
- `GET /info`: Service information and available agents
- `GET /docs`: Auto-generated API documentation (Swagger UI)
- `GET /openapi.json`: OpenAPI schema
- Agent-specific endpoints are auto-generated by ADK's `get_fast_api_app`

**Alternative: ADK API Server for A2A Communication**

For Agent-to-Agent (A2A) remote communication:

```bash
# Start remote A2A agent server
adk api_server --a2a --port 8001 movie_pitch_agent
```

### Artifacts

Movie pitches are saved as **session artifacts** using ADK's artifact service:
- Artifacts are stored per session
- Viewable in the Web UI under the "Artifacts" tab
- Currently uses `InMemoryArtifactService` (lost on restart)
- For production, configure `GcsArtifactService` to persist to Google Cloud Storage

### Production Considerations

1. **Session Storage**: SQLite is fine for development but use PostgreSQL/Cloud SQL for production with multiple instances
2. **Artifact Storage**: Use GCS (`GcsArtifactService`) for persistent artifact storage
3. **Authentication**: ADC works everywhere (local, Cloud Run, GKE, Compute Engine)
4. **Scaling**: Use multiple uvicorn workers or deploy to Cloud Run with autoscaling
5. **Monitoring**: Enable Cloud Logging with `ENABLE_CLOUD_LOGGING=true`